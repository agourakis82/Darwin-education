#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check for staged files containing secrets
echo "ğŸ” Checking for secrets..."
if git diff --cached --name-only | xargs grep -l "GROK_API_KEY\|MINIMAX_API_KEY\|supabase" 2>/dev/null; then
  echo "âŒ Found potential secrets in staged files!"
  echo "Do not commit API keys or credentials."
  exit 1
fi

# Check for large files
echo "ğŸ“¦ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
  size=$(git ls-files --stage "$file" | awk '{print $4}')
  if [ "$size" -gt 52428800 ]; then  # 50MB
    echo "$file"
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo "âŒ Found large files:"
  echo "$LARGE_FILES"
  echo "Large files should not be committed."
  exit 1
fi

# Type-check TypeScript
echo "ğŸ“ Type-checking TypeScript..."
pnpm type-check || exit 1

# Lint changed files
echo "ğŸ¨ Linting code..."
pnpm lint --fix || exit 1

# Run tests for changed packages
echo "ğŸ§ª Running tests..."
pnpm test --passWithNoTests || exit 1

echo "âœ… All checks passed!"
